<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/docs/4.1/assets/img/favicons/favicon.ico">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>SMART TWINS 4.0</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">


    <link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css" type="text/css">
    <script src="https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/viewer3D.min.js"></script>

    <style>

    </style>
    <!-- this project files -->
    <link href="css/main.css" rel="stylesheet" />
</head>

<body class="__web-inspector-hide-shortcut__">
    <nav class="navbar navbar-dark bg-primary fixed-top bg-primary flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">SMART TWINS 4.0</a>


        <ul class="navbar-nav px-3">
            <li class="nav-item text-nowrap">
                <a class="nav-link" href="#">Sign out</a>
            </li>
        </ul>
    </nav>

    <div class="row">

        <div class=" col-md-3 ml-sm-auto col-lg-3 px-4">
            <div class="panel-heading ">
                <label for="obras">Selecione a Obra</label>
                <select class="form-control" id="obras">
            </select>
            </div>
        </div>
    </div>
    <div class="row">

        <div class=" col-md-3 ml-sm-auto col-lg-3 px-4">
            <div class="panel-heading ">
                <label for="bloco">Selecione o bloco</label>
                <select class="form-control" id="bloco">
            </select>
            </div>
        </div>
    </div>
    <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4" style="margin-top: 31px;">
        <div class="chartjs-size-monitor" style=" position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;">
            <div class="chartjs-size-monitor-expand" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                <div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div>
            </div>
            <div class="chartjs-size-monitor-shrink" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                <div style="position:absolute;width:200%;height:200%;left:0; top:0"></div>
            </div>
        </div>

        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom col-xs-12 col-md-8">
            <h1 class="h2">Minha Obra</h1>
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a href="#forgeViewer" class="nav-link active" role="tab" data-toggle="tab">Tempo Real</a>
                </li>

                <li class="nav-item">
                    <a href="#forgeViewer1" class="nav-link" role="tab" data-toggle="tab">Projeto Inteiro</a>
                </li>


            </ul>






            <!-- jQuery first, then Bootstrap JS. -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
            <script src="https://cdn.rawgit.com/twbs/bootstrap/v4-dev/dist/js/bootstrap.js"></script>
            <div class="btn-toolbar mb-2 mb-md-0">

            </div>
        </div>




        <div class="tab-content col-xs-12 col-md-8">
            <div role="tabpanel" class="tab-pane fade in active" id="forgeViewer" class="col-xs-12 col-md-8"></div>
            <div role="tabpanel" class="tab-pane fade in active" id="forgeViewer1" class="col-xs-12 col-md-8"></div>

        </div>


    </main>
    </div>
    </div>


    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
    <script>
        feather.replace()
    </script>
    <!--Firebase-->
    <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.0/firebase-storage.js"></script>
    <!--Firebase-->
    <!--Extension-->
    <script src="js/PanelInfoViewerExtension.js"></script>
    <script src="js/ManutencaoViewerExtension.js"></script>
    <script src="js/NestedViewerExtension.js"></script>



    <script>
        var viewer;
        var options = {
            env: 'AutodeskProduction',
            api: 'derivativeV2', // TODO: for models uploaded to EMEA change this option to 'derivativeV2_EU'
            getAccessToken: getForgeToken
        };
        // var options = {
        //     env: 'AutodeskProduction',
        //     getAccessToken: getForgeToken
        // };

        Autodesk.Viewing.Initializer(options, function() {
            viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById('forgeViewer'), {
                extensions: ['PanelInfoViewerExtension', 'ManutencaoViewerExtension']
            });
            viewer.start();

            var documentId = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6d2djaWloemhodW11Z2J6Z29jc2dhaXZ0ZWpjbXZldHotcjIvUHIlQzMlQTlkaW8lMjBDT1JSSUdJRE8lMjAzJTIwKDMpLnJ2dA==';

            // var documentId = 'urn:' + urn;
            Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
        });


        function onDocumentLoadSuccess(doc) {
            var viewables = doc.getRoot().getDefaultGeometry();
            viewer.loadDocumentNode(doc, viewables).then(i => {
                // documented loaded, any action?

                var obra = document.getElementById('obras').value;
                var bloco = document.getElementById('bloco').value;
                var vetorBlocos = []
                firebase.database().ref('obras/' + obra + '/sequenciareal/' + bloco).once('value').then(snapshot => {
                    var todosBlocos = (Object.keys(snapshot.val()));
                    todosBlocos.forEach(value => {
                        // snapshot.val()[value].status
                        vetorBlocos.push({
                            bloco: value,
                            status: snapshot.val()[value].status
                        })
                    })
                    var vetorTodosElementos = []
                    getAllLeafComponents(viewer, (dbIds) => {
                        //Propriedade que quero buscar das elemetos dos setores e formas
                        const filteredProps = ['Numeração', "Agrupamento"];
                        // Get only the properties we need for the leaf dbIds
                        this.viewer.model.getBulkProperties(dbIds, filteredProps, (items) => {
                            // Iterate through the elements we found
                            items.forEach((item) => {
                                // and iterate through each propertys
                                item.properties.forEach(function(prop) {
                                    vetorTodosElementos.push(item);
                                });
                            });
                            //Removendo elementos duplicados
                            var elementos = [...new Set(vetorTodosElementos)];

                            var isolated = []
                            var aux = 0;
                            for (i = vetorBlocos.length - 1; i >= 0; i--) {
                                //Identifica o primeiro pavimento com forma
                                if (vetorBlocos[i].status == 1 && aux == 0) {
                                    elementos.forEach(value => {
                                        if ('0' + value.properties[1].displayValue == vetorBlocos[i].bloco ||
                                            value.properties[1].displayValue == 0) {
                                            console.log("aqui1")
                                            isolated.push(value.dbId);
                                        }
                                    })
                                    aux = 1;
                                }
                                //pavimentos anteriores sem formas
                                else if (vetorBlocos[i].status == 1 && aux == 1) {
                                    console.log(vetorBlocos[i].bloco)
                                    elementos.forEach(value => {
                                        if ((!value.properties[0].displayValue) && '0' + value.properties[1].displayValue == vetorBlocos[i].bloco) {
                                            console.log("aqui2")
                                            isolated.push(value.dbId);
                                        }
                                    })
                                }
                                //obra só com estrutura do piso
                                else if (vetorBlocos[i].status == 0 && vetorBlocos[i].bloco == vetorBlocos[0].bloco) {
                                    elementos.forEach(value => {
                                        if (value.properties[1].displayValue == 0) {
                                            console.log("aqui3")
                                            isolated.push(value.dbId);
                                        }
                                    })
                                }
                            }
                            viewer.isolate(isolated)
                            viewer.setGhosting(false);
                        });
                    });

                });
            });
            // NestedViewerExtension
            viewer.loadExtension("NestedViewerExtension", {
                    filter: ["2d", "3d"],
                    crossSelection: true
                })
                // NestedViewerExtension
        }

        function onDocumentLoadFailure(viewerErrorCode) {
            console.error('onDocumentLoadFailure() - errorCode:' + viewerErrorCode);
        }

        function getForgeToken(callback) {
            fetch('/api/forge/oauth/token').then(res => {
                res.json().then(data => {
                    callback(data.access_token, data.expires_in);
                });
            });
        }
    </script>
    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyCk_aoscgy9uwGQJ3OfEcBulfttjH2Mzxw",
            authDomain: "carol-56175.firebaseapp.com",
            databaseURL: "https://carol-56175.firebaseio.com",
            projectId: "carol-56175",
            storageBucket: "carol-56175.appspot.com",
            messagingSenderId: "497363212618",
            appId: "1:497363212618:web:39701f8718c372bcbc09b3",
            measurementId: "G-9TE9525H3C"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        // firebase.analytics();

        firebase.database().ref('obras/').once('value', function(snapshot) {
            var i = 0;
            snapshot.forEach(function(item) {
                var select = document.getElementById("obras");
                var options = document.createElement("option");
                opt_txt = document.createTextNode(item.key);
                options.appendChild(opt_txt);
                options.setAttribute("value", item.key);
                select.appendChild(options);
                i++;
            });
            $("#obras").val($("#obras option:first").val());
            var obra = document.getElementById('obras').value;
            console.log(obra)
            firebase.database().ref('obras/' + obra + '/sequenciareal').once('value', function(snapshot) {
                var i = 0;
                snapshot.forEach(function(item) {
                    var select = document.getElementById("bloco");
                    var options = document.createElement("option");
                    opt_txt = document.createTextNode(item.key);
                    options.appendChild(opt_txt);
                    options.setAttribute("value", item.key);
                    select.appendChild(options);
                    i++;
                });
                $("#bloco").val($("#bloco option:first").val());
            });
        })
    </script>
    <script>
        $('#obras').on('change', function() {
            var obra = document.getElementById('obras').value;
            $("#bloco").empty();
            firebase.database().ref('obras/' + obra + '/sequenciareal').once('value', function(snapshot) {
                var i = 0;
                snapshot.forEach(function(item) {
                    var select = document.getElementById("bloco");
                    var options = document.createElement("option");
                    opt_txt = document.createTextNode(item.key);
                    options.appendChild(opt_txt);
                    options.setAttribute("value", item.key);
                    select.appendChild(options);
                    i++;
                });
                $("#bloco").val($("#bloco option:first").val());
            });

        });
    </script>

    <script>
        var viewer;
        var options = {
            env: 'AutodeskProduction',
            api: 'derivativeV2', // TODO: for models uploaded to EMEA change this option to 'derivativeV2_EU'
            getAccessToken: getForgeToken
        };
        // var options = {
        //     env: 'AutodeskProduction',
        //     getAccessToken: getForgeToken
        // };

        Autodesk.Viewing.Initializer(options, function() {
            viewer = new Autodesk.Viewing.GuiViewer3D(document.getElementById('forgeViewer1'), {
                extensions: ['PanelInfoViewerExtension', 'ManutencaoViewerExtension']
            });
            viewer.start();

            var documentId = 'urn:dXJuOmFkc2sub2JqZWN0czpvcy5vYmplY3Q6d2djaWloemhodW11Z2J6Z29jc2dhaXZ0ZWpjbXZldHotcjIvUHIlQzMlQTlkaW8lMjBDT1JSSUdJRE8lMjAzJTIwKDMpLnJ2dA==';

            // var documentId = 'urn:' + urn;
            Autodesk.Viewing.Document.load(documentId, onDocumentLoadSuccess, onDocumentLoadFailure);
        });


        function onDocumentLoadSuccess(doc) {
            var viewables = doc.getRoot().getDefaultGeometry();
            viewer.loadDocumentNode(doc, viewables).then(i => {
                // documented loaded, any action?

                var obra = document.getElementById('obras').value;
                var bloco = document.getElementById('bloco').value;
                var vetorBlocos = []
                firebase.database().ref('obras/' + obra + '/sequenciareal/' + bloco).once('value').then(snapshot => {
                    var todosBlocos = (Object.keys(snapshot.val()));
                    todosBlocos.forEach(value => {
                        // snapshot.val()[value].status
                        vetorBlocos.push({
                            bloco: value,
                            status: snapshot.val()[value].status
                        })
                    })
                    var vetorTodosElementos = []
                    getAllLeafComponents(viewer, (dbIds) => {
                        //Propriedade que quero buscar das elemetos dos setores e formas
                        const filteredProps = ['Numeração', "Agrupamento"];
                        // Get only the properties we need for the leaf dbIds
                        this.viewer.model.getBulkProperties(dbIds, filteredProps, (items) => {
                            // Iterate through the elements we found
                            items.forEach((item) => {
                                // and iterate through each propertys
                                item.properties.forEach(function(prop) {
                                    vetorTodosElementos.push(item);
                                });
                            });
                            //Removendo elementos duplicados
                            var elementos = [...new Set(vetorTodosElementos)];

                            var isolated = []
                            var aux = 0;
                            for (i = vetorBlocos.length - 1; i >= 0; i--) {
                                //Identifica o primeiro pavimento com forma
                                if (vetorBlocos[i].status == 1 && aux == 0) {
                                    elementos.forEach(value => {
                                        if ('0' + value.properties[1].displayValue == vetorBlocos[i].bloco ||
                                            value.properties[1].displayValue == 0) {
                                            console.log("aqui1")
                                            isolated.push(value.dbId);
                                        }
                                    })
                                    aux = 1;
                                }
                                //pavimentos anteriores sem formas
                                else if (vetorBlocos[i].status == 1 && aux == 1) {
                                    console.log(vetorBlocos[i].bloco)
                                    elementos.forEach(value => {
                                        if ((!value.properties[0].displayValue) && '0' + value.properties[1].displayValue == vetorBlocos[i].bloco) {
                                            console.log("aqui2")
                                            isolated.push(value.dbId);
                                        }
                                    })
                                }
                                //obra só com estrutura do piso
                                else if (vetorBlocos[i].status == 0 && vetorBlocos[i].bloco == vetorBlocos[0].bloco) {
                                    elementos.forEach(value => {
                                        if (value.properties[1].displayValue == 0) {
                                            console.log("aqui3")
                                            isolated.push(value.dbId);
                                        }
                                    })
                                }
                            }
                            viewer.isolate(isolated)
                            viewer.setGhosting(false);
                        });
                    });

                });
            });
            // NestedViewerExtension
            viewer.loadExtension("NestedViewerExtension", {
                    filter: ["2d", "3d"],
                    crossSelection: true
                })
                // NestedViewerExtension
        }

        function onDocumentLoadFailure(viewerErrorCode) {
            console.error('onDocumentLoadFailure() - errorCode:' + viewerErrorCode);
        }

        function getForgeToken(callback) {
            fetch('/api/forge/oauth/token').then(res => {
                res.json().then(data => {
                    callback(data.access_token, data.expires_in);
                });
            });
        }
    </script>
</body>

</html>